@using ITGlobalProject.Models
@{
    var doanhthulst = Session["thongke-chitiet-doanhthu"] as IEnumerable<PaymentHistory>;
    var maxyear = DateTime.Now.Year;
    int selectYear = Int32.Parse(Session["nam-thongke"].ToString());
}
<div id="appendthongkedoanhthu" class="card h-100">
    <div class="card-header">
        <div class="row">
            <div class="col-md-6 col-6">
                <h4 style="margin-top: 15px">THỐNG KÊ DOANH THU NĂM @Session["nam-thongke"].ToString()</h4>
            </div>
            <div class="col-md-6 col-6 text-end">
                <select id="chonnamthongke" class="selectpicker">
                    @for (int i = 2023; i <= maxyear; i++)
                    {
                        if (selectYear == i)
                        {
                            <option selected value="@i">Doanh Thu Năm @i</option>
                        }
                        else
                        {
                            <option value="@i">Doanh Thu Năm @i</option>
                        }
                    }
                </select>
                &ensp;
                <button style="width: 200px" class="btn btn-primary"><i class="fe fe-download"> </i> Xuất</button>
            </div>
        </div>
    </div>
    <!-- card body -->
    <div class="card-body">
        <!-- chart -->
        <div id="sessionChart"></div>
        <!-- table -->
        <table id="dataTableBasic" class="table table-hover" style="width:100%">
            <thead class="table-light">
                <tr>
                    <th scope="col" class="text-nowrap border-top-0">#</th>
                    <th scope="col" class="text-nowrap border-top-0">Thời gian</th>
                    <th scope="col" class="text-nowrap border-top-0">Mã Dự Án</th>
                    <th scope="col" class="text-nowrap border-top-0">Tên dự án</th>
                    <th scope="col" class="text-nowrap border-top-0">Số tiền</th>
                    <th scope="col" class="text-nowrap border-top-0">Ghi chú</th>
                </tr>
            </thead>
            <tbody>
                @if (doanhthulst.Count() > 0)
                {
                    int i = 0;
                    foreach (var item in doanhthulst)
                    {
                        i++;
                        <tr>
                            <td class="align-middle text-nowrap">
                                @i
                            </td>
                            <td class="align-middle text-nowrap">
                                @item.Date.ToString("HH:mm dd/MM/yyyy")
                            </td>
                            <td class="align-middle text-nowrap">
                                <a target="_blank" href="@Url.Action("chitietduan", "quanlyduan", new {id = item.Debts.ID_Project})" class="text-dark text-inherit">@item.Debts.Projects.ID_Project</a>
                            </td>
                            <td class="align-middle">
                                <a target="_blank" href="@Url.Action("chitietduan", "quanlyduan", new {id = item.Debts.ID_Project})" class="text-dark text-inherit">@item.Debts.Projects.Name</a>
                            </td>
                            <td class="align-middle text-nowrap">
                                @item.Price.Value.ToString("0,0") đ
                            </td>
                            <td class="align-middle">
                                @item.Contents
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="align-middle text-center">
                            Không có dữ liệu để hiển thị.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <script>
    $(document).ready(function () {

        //table2excel.js
        ; (function ($, window, document, undefined) {
            var pluginName = "table2excel",

                defaults = {
                    exclude: ".noExl",
                    name: "Table2Excel",
                    filename: "table2excel",
                    fileext: ".xls",
                    exclude_img: true,
                    exclude_links: true,
                    exclude_inputs: true
                };

            // The actual plugin constructor
            function Plugin(element, options) {
                this.element = element;
                // jQuery has an extend method which merges the contents of two or
                // more objects, storing the result in the first object. The first object
                // is generally empty as we don't want to alter the default options for
                // future instances of the plugin
                //
                this.settings = $.extend({}, defaults, options);
                this._defaults = defaults;
                this._name = pluginName;
                this.init();
            }

            Plugin.prototype = {
                init: function () {
                    var e = this;

                    var utf8Heading = "<meta http-equiv=\"content-type\" content=\"application/vnd.ms-excel; charset=UTF-8\">";
                    e.template = {
                        head: "<html xmlns:o=\"urn:schemas-microsoft-com:office:office\" xmlns:x=\"urn:schemas-microsoft-com:office:excel\" xmlns=\"http://www.w3.org/TR/REC-html40\">" + utf8Heading + "<head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets>",
                        sheet: {
                            head: "<x:ExcelWorksheet><x:Name>",
                            tail: "</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>"
                        },
                        mid: "</x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body>",
                        table: {
                            head: "<table>",
                            tail: "</table>"
                        },
                        foot: "</body></html>"
                    };

                    e.tableRows = [];

                    // get contents of table except for exclude
                    $(e.element).each(function (i, o) {
                        var tempRows = "";
                        $(o).find("tr").not(e.settings.exclude).each(function (i, p) {

                            tempRows += "<tr>";
                            $(p).find("td,th").not(e.settings.exclude).each(function (i, q) { // p did not exist, I corrected

                                var rc = {
                                    rows: $(this).attr("rowspan"),
                                    cols: $(this).attr("colspan"),
                                    flag: $(q).find(e.settings.exclude)
                                };

                                if (rc.flag.length > 0) {
                                    tempRows += "<td> </td>"; // exclude it!!
                                } else {
                                    if (rc.rows & rc.cols) {
                                        tempRows += "<td>" + $(q).html() + "</td>";
                                    } else {
                                        tempRows += "<td";
                                        if (rc.rows > 0) {
                                            tempRows += " rowspan=\'" + rc.rows + "\' ";
                                        }
                                        if (rc.cols > 0) {
                                            tempRows += " colspan=\'" + rc.cols + "\' ";
                                        }
                                        tempRows += "/>" + $(q).html() + "</td>";
                                    }
                                }
                            });

                            tempRows += "</tr>";
                            console.log(tempRows);

                        });
                        // exclude img tags
                        if (e.settings.exclude_img) {
                            tempRows = exclude_img(tempRows);
                        }

                        // exclude link tags
                        if (e.settings.exclude_links) {
                            tempRows = exclude_links(tempRows);
                        }

                        // exclude input tags
                        if (e.settings.exclude_inputs) {
                            tempRows = exclude_inputs(tempRows);
                        }
                        e.tableRows.push(tempRows);
                    });

                    e.tableToExcel(e.tableRows, e.settings.name, e.settings.sheetName);
                },

                tableToExcel: function (table, name, sheetName) {
                    var e = this, fullTemplate = "", i, link, a;

                    e.format = function (s, c) {
                        return s.replace(/{(\w+)}/g, function (m, p) {
                            return c[p];
                        });
                    };

                    sheetName = typeof sheetName === "undefined" ? "Sheet" : sheetName;

                    e.ctx = {
                        worksheet: name || "Worksheet",
                        table: table,
                        sheetName: sheetName
                    };

                    fullTemplate = e.template.head;

                    if ($.isArray(table)) {
                        for (i in table) {
                            //fullTemplate += e.template.sheet.head + "{worksheet" + i + "}" + e.template.sheet.tail;
                            fullTemplate += e.template.sheet.head + sheetName + i + e.template.sheet.tail;
                        }
                    }

                    fullTemplate += e.template.mid;

                    if ($.isArray(table)) {
                        for (i in table) {
                            fullTemplate += e.template.table.head + "{table" + i + "}" + e.template.table.tail;
                        }
                    }

                    fullTemplate += e.template.foot;

                    for (i in table) {
                        e.ctx["table" + i] = table[i];
                    }
                    delete e.ctx.table;

                    var isIE = false || !!document.documentMode; // this works with IE10 and IE11 both :)
                    //if (typeof msie !== "undefined" && msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./))      // this works ONLY with IE 11!!!
                    if (isIE) {
                        if (typeof Blob !== "undefined") {
                            //use blobs if we can
                            fullTemplate = e.format(fullTemplate, e.ctx); // with this, works with IE
                            fullTemplate = [fullTemplate];
                            //convert to array
                            var blob1 = new Blob(fullTemplate, { type: "text/html" });
                            window.navigator.msSaveBlob(blob1, getFileName(e.settings));
                        } else {
                            //otherwise use the iframe and save
                            //requires a blank iframe on page called txtArea1
                            txtArea1.document.open("text/html", "replace");
                            txtArea1.document.write(e.format(fullTemplate, e.ctx));
                            txtArea1.document.close();
                            txtArea1.focus();
                            sa = txtArea1.document.execCommand("SaveAs", true, getFileName(e.settings));
                        }

                    } else {
                        var blob = new Blob([e.format(fullTemplate, e.ctx)], { type: "application/vnd.ms-excel" });
                        window.URL = window.URL || window.webkitURL;
                        link = window.URL.createObjectURL(blob);
                        a = document.createElement("a");
                        a.download = getFileName(e.settings);
                        a.href = link;

                        document.body.appendChild(a);

                        a.click();

                        document.body.removeChild(a);
                    }

                    return true;
                }
            };

            function getFileName(settings) {
                return (settings.filename ? settings.filename : "table2excel");
            }

            // Removes all img tags
            function exclude_img(string) {
                var _patt = /(\s+alt\s*=\s*"([^"]*)"|\s+alt\s*=\s*'([^']*)')/i;
                return string.replace(/<img[^>]*>/gi, function myFunction(x) {
                    var res = _patt.exec(x);
                    if (res !== null && res.length >= 2) {
                        return res[2];
                    } else {
                        return "";
                    }
                });
            }

            // Removes all link tags
            function exclude_links(string) {
                return string.replace(/<a[^>]*>|<\/a>/gi, "");
            }

            // Removes input params
            function exclude_inputs(string) {
                var _patt = /(\s+value\s*=\s*"([^"]*)"|\s+value\s*=\s*'([^']*)')/i;
                return string.replace(/<input[^>]*>|<\/input>/gi, function myFunction(x) {
                    var res = _patt.exec(x);
                    if (res !== null && res.length >= 2) {
                        return res[2];
                    } else {
                        return "";
                    }
                });
            }

            $.fn[pluginName] = function (options) {
                var e = this;
                e.each(function () {
                    if (!$.data(e, "plugin_" + pluginName)) {
                        $.data(e, "plugin_" + pluginName, new Plugin(this, options));
                    }
                });

                // chain jQuery functions
                return e;
            };

        })(jQuery, window, document);
        //xuất thống kê
        $('#btnxuatthongke').on('click', function () {
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
            var yyyy = today.getFullYear();

            var SweetAlert2Demo = function () {
                var initDemos = function () {
                    swal({
                        title: 'Tải xuống thống kê?',
                        text: "Bạn có muốn tải xuống toàn bộ danh sách thống kê doanh thu tính đến thời điểm hiện tại?",
                        type: 'warning',
                        buttons: {
                            cancel: {
                                visible: true,
                                text: ' Hủy Bỏ ',
                                className: 'btn btn-danger'
                            },
                            confirm: {
                                text: 'Xác Nhận',
                                className: 'btn btn-success'
                            }
                        }
                    }).then((taixuong) => {
                        if (taixuong) {
                            $("#xuatthongke").table2excel({
                                filename: 'thong-ke-doanh-thu-' + yyyy + '-' + mm + '-' + dd + '.xls'
                            });
                        }
                    });
                };
                return {
                    init: function () {
                        initDemos();
                    },
                };
            }();

            jQuery(document).ready(function () {
                SweetAlert2Demo.init();
            });
        });

        //Chart doanh thu
        var lstDoanhThu = @Html.Raw(Json.Encode(Session["lst-doanhthu-nam"]));
        var lstDuAn = @Html.Raw(Json.Encode(Session["lst-duan-nam"]));

        var doanhthutach = lstDoanhThu.split('-');
        var duantach = lstDuAn.split('-');

        var options = {
            series: [{
                name: 'Doanh thu',
                data: []
            }, {
                name: 'Số dự án',
                data: []
            }],
            title: {
                text: '\n',
                margin: 20,
                floating: false
            },
            chart: {
                height: 350,
                type: 'area'
            },
            dataLabels: {
                enabled: false,
            },
            colors: [window.theme.danger, window.theme.primary],
            stroke: {
                curve: 'smooth'
            },
            xaxis: {
                type: 'month',
                categories: ["@Session["nam-thongke"].ToString()-01", "@Session["nam-thongke"].ToString()-02", "@Session["nam-thongke"].ToString()-03", "@Session["nam-thongke"].ToString()-04", "@Session["nam-thongke"].ToString()-05"
                    , "@Session["nam-thongke"].ToString()-06", "@Session["nam-thongke"].ToString()-07", "@Session["nam-thongke"].ToString()-08", "@Session["nam-thongke"].ToString()-09", "@Session["nam-thongke"].ToString()-10", "@Session["nam-thongke"].ToString()-11", "@Session["nam-thongke"].ToString()-12"]
            },
            yaxis: [{
            }, {
                opposite: true,
            }]
        };

        options.series[0].data = doanhthutach;
        options.series[1].data = duantach;
        var chart = new ApexCharts(document.querySelector("#sessionChart"), options);
        chart.render();

        //CHọn năm thống kê
        $('#chonnamthongke').on('change', function () {
            var nam = $(this).val();
            var formData = new FormData();
            formData.append("nam", nam);
            $('#AjaxLoader').fadeIn('slow');
            $.ajax({
                url: $('#requestPath').val() + "admins/dashboard/chonxemdoanhthu",
                type: 'POST',
                dataType: 'html',
                contentType: false,
                processData: false,
                data: formData
            }).done(function (ketqua) {
                $('#appendthongkedoanhthu').replaceWith(ketqua);
                $('#chonnamthongke').selectpicker();
                $.when(
                    $.getScript($('#requestPath').val() + "Content/Admin/assets/js/theme.min.js"),

                    $.Deferred(function (deferred) {
                        $(deferred.resolve);
                    })
                ).done(function () {
                });
                $('#AjaxLoader').fadeOut('slow');
            });
        });
    });

    </script>
</div>
